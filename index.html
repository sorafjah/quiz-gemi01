<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算プリント作成アプリ２</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 印刷時のスタイル */
        @media print {
            /* 画面上のUI要素はすべて非表示に */
            body > *:not(#print-area) {
                display: none;
            }
            /* 印刷エリアだけを表示 */
            #print-area {
                display: block !important;
                margin: 0;
                padding: 0;
            }
            #print-sheet {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 10mm;
                width: 100%;
                height: 100%;
                page-break-after: always;
            }
            /* 印刷ボタンを非表示 */
            #print-button-container {
                display: none;
            }
        }
        /* 画面表示用のA4サイズコンテナ */
        #print-sheet {
            background: white;
            width: 210mm;
            height: 297mm;
            margin: 2rem auto;
            /* 上、右、下、左 の順。左余白を増やす */
            padding: 20mm 15mm 20mm 25mm;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">計算プリント作成アプリ２</h1>
            <p class="text-gray-500 mt-2">問題の種類や範囲を自由に設定して、オリジナルの計算プリントを作成しましょう。</p>
        </header>

        <!-- 設定フォーム -->
        <form id="settings-form" class="bg-white p-6 rounded-2xl shadow-lg mb-8 space-y-8">
            
            <!-- 1. 問題設定 -->
            <fieldset>
                <legend class="text-xl font-bold text-gray-700 mb-4 border-b-2 border-indigo-500 pb-2">1. 問題設定</legend>
                <div id="problem-settings-container" class="space-y-4">
                    <!-- 問題設定ブロックがここに追加されます -->
                </div>
                <button type="button" id="add-problem-btn" class="mt-4 flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    問題の種類を追加
                </button>
                <!-- エラーメッセージ表示エリア -->
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mt-4" role="alert">
                    <strong class="font-bold">エラー:</strong>
                    <span class="block sm:inline" id="error-text"></span>
                </div>
            </fieldset>

            <!-- 2. 全体の並び順設定 -->
            <fieldset>
                <legend class="text-xl font-bold text-gray-700 mb-4 border-b-2 border-indigo-500 pb-2">2. 全体の表示順</legend>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 flex-1">
                        <input type="radio" name="global-order" value="created" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <span class="ml-3 text-gray-700">作ったままの順</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 flex-1">
                        <input type="radio" name="global-order" value="grouped" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <span class="ml-3 text-gray-700">ジャンルごとに固める</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 flex-1">
                        <input type="radio" name="global-order" value="random" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <span class="ml-3 text-gray-700">全ジャンルでランダム</span>
                    </label>
                </div>
            </fieldset>

            <!-- 3. コメントの設定 -->
            <fieldset>
                <legend class="text-xl font-bold text-gray-700 mb-4 border-b-2 border-indigo-500 pb-2">コメントの設定</legend>
                 <div class="space-y-4">
                    <div>
                        <label for="header-text" class="block text-sm font-medium text-gray-700 mb-1">問題文の右上にコメントを記入 (任意)</label>
                        <input type="text" id="header-text" placeholder="(例: 10月13日)" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="footer-comment" class="block text-sm font-medium text-gray-700 mb-1">問題文の最後にコメントを記入(任意)</label>
                        <textarea id="footer-comment" rows="2" placeholder="（例：問題を作って書こう）" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>
            </fieldset>

            <!-- 操作ボタン -->
            <div class="flex items-center justify-end gap-4 pt-4 border-t">
                <button type="button" id="reset-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">リセット</button>
                <button type="submit" id="create-btn" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition-colors shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">プリントを作成</button>
            </div>
        </form>

    </div>

    <!-- 印刷プレビューエリア -->
    <div id="print-area" class="hidden">
        <div id="print-button-container" class="text-center my-4 flex justify-center gap-4">
            <button id="toggle-answers-button" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">解答を表示</button>
            <button id="print-button" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="inline h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                印刷する
            </button>
        </div>
        <div id="print-sheet">
            <header class="flex justify-between items-center mb-8">
                <span class="text-lg">なまえ＿＿＿＿＿＿＿＿＿＿＿＿</span>
                <span id="print-header-text" class="text-lg"></span>
            </header>
            <main id="print-content" class="grow grid grid-cols-2 gap-x-16 gap-y-12 text-xl content-around">
                <!-- 問題がここに挿入されます -->
            </main>
            <footer id="print-footer-comment" class="pt-4 text-base text-left text-gray-600">
                <!-- コメントがここに挿入されます -->
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('settings-form');
            const addProblemBtn = document.getElementById('add-problem-btn');
            const problemSettingsContainer = document.getElementById('problem-settings-container');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const printArea = document.getElementById('print-area');
            const printContent = document.getElementById('print-content');
            const printHeaderText = document.getElementById('print-header-text');
            const printFooterComment = document.getElementById('print-footer-comment');
            const printButton = document.getElementById('print-button');
            const resetBtn = document.getElementById('reset-btn');
            const toggleAnswersBtn = document.getElementById('toggle-answers-button');
            const createBtn = document.getElementById('create-btn');

            let settingId = 0;
            let answersVisible = false;

            // --- ユーティリティ ---
            const showError = (msg) => {
                errorText.textContent = msg;
                errorMessage.classList.remove('hidden');
            };
            const hideError = () => {
                if (!createBtn.disabled) { // only hide if not disabled by other error
                    errorMessage.classList.add('hidden');
                }
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // --- リアルタイム問題数チェック ---
            const checkTotalProblems = () => {
                const countInputs = problemSettingsContainer.querySelectorAll('input[id^="problem-count-"]');
                let total = 0;
                countInputs.forEach(input => {
                    const val = parseInt(input.value);
                    if (!isNaN(val) && val > 0) {
                        total += val;
                    }
                });

                if (total > 16) {
                    showError(`合計問題数が16問を超えています。(現在: ${total}問)`);
                    createBtn.disabled = true;
                    createBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    hideError();
                    createBtn.disabled = false;
                    createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                return total;
            };
            
            problemSettingsContainer.addEventListener('input', (e) => {
                if(e.target.matches('input[id^="problem-count-"]')) {
                    checkTotalProblems();
                }
            });


            // --- UI制御 ---

            // 問題設定ブロックを追加する
            addProblemBtn.addEventListener('click', () => {
                const id = settingId++;
                const settingBlock = document.createElement('div');
                settingBlock.className = 'p-4 border rounded-lg bg-gray-50 relative';
                settingBlock.id = `setting-${id}`;
                settingBlock.innerHTML = createSettingHTML(id);
                problemSettingsContainer.appendChild(settingBlock);
                
                const typeSelect = settingBlock.querySelector(`#problem-type-${id}`);
                // 動的に追加した要素にイベントリスナーを設定
                typeSelect.addEventListener('change', (e) => {
                    updateProblemTypeUI(id, e.target.value);
                });
                // 新しく追加したブロックのUIを初期化
                updateProblemTypeUI(id, typeSelect.value);
                checkTotalProblems();
            });

            // 設定ブロックのHTMLを生成
            const createSettingHTML = (id) => `
                <button type="button" onclick="removeSetting(${id})" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="problem-type-${id}" class="block text-sm font-medium text-gray-700">問題の種類</label>
                        <select id="problem-type-${id}" data-id="${id}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="addition">足し算</option>
                            <option value="subtraction">引き算</option>
                            <option value="multiplication">かけ算</option>
                        </select>
                    </div>
                    <div id="range-inputs-${id}" class="col-span-1 sm:col-span-2">
                        <!-- ここに範囲設定UIが挿入される -->
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label for="problem-count-${id}" class="block text-sm font-medium text-gray-700">問題数</label>
                        <input type="number" id="problem-count-${id}" min="1" max="16" value="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="col-span-1 sm:col-span-2">
                        <label for="problem-order-${id}" class="block text-sm font-medium text-gray-700">問題の順番</label>
                        <select id="problem-order-${id}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="random">ランダムに並べる</option>
                            <option value="asc">小さい順に並べる</option>
                        </select>
                    </div>
                </div>
            `;
            
            // 問題の種類に応じてUIを更新
            const updateProblemTypeUI = (id, type) => {
                const container = document.getElementById(`range-inputs-${id}`);
                let symbol;
                switch(type) {
                    case 'addition':
                        symbol = '+';
                        break;
                    case 'subtraction':
                        symbol = '−';
                        break;
                    case 'multiplication':
                        symbol = '×';
                        break;
                }
                
                container.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">範囲 (最小〜最大)</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="number" id="min1-${id}" value="1" min="0" class="w-full text-center border-gray-300 rounded-md">
                        <span>〜</span>
                        <input type="number" id="max1-${id}" value="10" min="0" class="w-full text-center border-gray-300 rounded-md">
                        <span class="text-xl font-bold mx-2">${symbol}</span>
                        <input type="number" id="min2-${id}" value="1" min="0" class="w-full text-center border-gray-300 rounded-md">
                        <span>〜</span>
                        <input type="number" id="max2-${id}" value="10" min="0" class="w-full text-center border-gray-300 rounded-md">
                    </div>
                `;
            };
            
            // 設定ブロックを削除
            window.removeSetting = (id) => {
                document.getElementById(`setting-${id}`).remove();
                checkTotalProblems();
            };

            // 初期状態で足し算を一つ追加
            addProblemBtn.click();

            // --- メインロジック ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                printArea.classList.add('hidden');

                const totalProblems = checkTotalProblems();
                if (totalProblems > 16) return;

                const settings = [];
                const settingElements = problemSettingsContainer.children;

                // 各設定ブロックから情報を収集
                for (let i = 0; i < settingElements.length; i++) {
                    const el = settingElements[i];
                    const id = el.id.split('-')[1];
                    const type = document.getElementById(`problem-type-${id}`).value;
                    const countStr = document.getElementById(`problem-count-${id}`).value;
                    const order = document.getElementById(`problem-order-${id}`).value;

                    if (countStr === '' || parseInt(countStr) <= 0) {
                        showError(`設定 ${i + 1}番目の問題数を1以上で入力してください。`);
                        return;
                    }
                    const count = parseInt(countStr);
                    
                    const min1Val = document.getElementById(`min1-${id}`).value;
                    const max1Val = document.getElementById(`max1-${id}`).value;
                    const min2Val = document.getElementById(`min2-${id}`).value;
                    const max2Val = document.getElementById(`max2-${id}`).value;

                    if (min1Val === '' || max1Val === '' || min2Val === '' || max2Val === '') {
                         showError(`設定 ${i + 1}番目の範囲に数字をすべて入力してください。`);
                         return;
                    }
                    const range = {
                        min1: parseInt(min1Val), max1: parseInt(max1Val),
                        min2: parseInt(min2Val), max2: parseInt(max2Val),
                    };
                    if (range.min1 > range.max1 || range.min2 > range.max2) {
                        showError(`設定 ${i + 1}番目の範囲指定が正しくありません（最小値 > 最大値）。`);
                        return;
                    }
                    
                    settings.push({ type, count, order, range });
                }

                // バリデーション
                if (settings.length === 0) {
                    showError('問題の種類を少なくとも1つ追加してください。');
                    return;
                }
                if (totalProblems <= 0) {
                    showError('問題数を1以上に設定してください。');
                    return;
                }
                
                // 問題生成
                let problemGroups = [];
                for (const setting of settings) {
                    const generated = generateProblems(setting);
                    if(generated.length < setting.count) {
                        showError('指定された範囲と問題数では、重複しない問題を作成できませんでした。範囲を広げるか問題数を減らしてください。');
                        return;
                    }
                    problemGroups.push(generated);
                }
                
                // 全体の並び順
                const globalOrder = document.querySelector('input[name="global-order"]:checked').value;
                let allProblems = [];
                if (globalOrder === 'grouped') {
                    // ジャンルごとにまとめるロジックを修正
                    const grouped = { addition: [], subtraction: [], multiplication: [] };
                    problemGroups.forEach(group => {
                        if (group.length > 0) {
                            const type = group[0].type;
                            grouped[type].push(...group);
                        }
                    });
                    allProblems = [...grouped.addition, ...grouped.subtraction, ...grouped.multiplication];
                } else if (globalOrder === 'random') {
                    allProblems = shuffleArray(problemGroups.flat());
                } else { // created
                    allProblems = problemGroups.flat();
                }

                // 解答表示ボタンの状態をリセット
                answersVisible = false;
                toggleAnswersBtn.textContent = '解答を表示';

                // プリント表示
                displayPrint(allProblems);
            });

            // --- 問題生成 ---
            const generateProblems = (setting) => {
                const { type, count, range, order } = setting;
                
                // 全ての組み合わせ候補を生成
                let candidates = [];
                if (type === 'addition') {
                    for (let i = range.min1; i <= range.max1; i++) {
                        for (let j = range.min2; j <= range.max2; j++) {
                            candidates.push({ q: `${i} + ${j}`, a: i + j, n1: i, n2: j, type: type });
                        }
                    }
                } else if (type === 'subtraction') {
                    for (let i = range.min1; i <= range.max1; i++) {
                        for (let j = range.min2; j <= range.max2; j++) {
                            if (i - j >= 0) {
                                candidates.push({ q: `${i} − ${j}`, a: i - j, n1: i, n2: j, type: type });
                            }
                        }
                    }
                } else if (type === 'multiplication') {
                    for (let i = range.min1; i <= range.max1; i++) {
                        for (let j = range.min2; j <= range.max2; j++) {
                            candidates.push({ q: `${i} × ${j}`, a: i * j, n1: i, n2: j, type: type });
                        }
                    }
                }

                // 並び替えと選択
                let problems;
                if (order === 'asc') {
                    if (type === 'multiplication') {
                        // かけ算で小さい順の場合: ランダムに指定数選んでからソート
                        const shuffled = shuffleArray(candidates);
                        const selected = shuffled.slice(0, count);
                        selected.sort((a, b) => (a.n1 !== b.n1) ? a.n1 - b.n1 : a.n2 - b.n2);
                        problems = selected;
                    } else {
                        // 足し算・引き算で小さい順の場合: 全体をソートしてから指定数選ぶ
                        candidates.sort((a, b) => (a.n1 !== b.n1) ? a.n1 - b.n1 : a.n2 - b.n2);
                        problems = candidates.slice(0, count);
                    }
                } else { // 'random'
                    // ランダムの場合: 全体をシャッフルしてから指定数選ぶ
                    const shuffled = shuffleArray(candidates);
                    problems = shuffled.slice(0, count);
                }
                
                return problems;
            };

            // --- 表示処理 ---
            const displayPrint = (problems) => {
                const headerText = document.getElementById('header-text').value;
                const footerComment = document.getElementById('footer-comment').value;

                printHeaderText.textContent = headerText;
                printFooterComment.textContent = footerComment;
                printContent.innerHTML = '';

                problems.forEach((p) => {
                    const problemEl = document.createElement('div');
                    problemEl.className = 'flex items-baseline problem-item';
                    problemEl.dataset.question = p.q;
                    problemEl.dataset.answer = p.a;
                    problemEl.innerHTML = `<span class="flex-1">${p.q}</span>`;
                    printContent.appendChild(problemEl);
                });

                printArea.classList.remove('hidden');
                // 表示後にスクロールしてプレビューを見せる
                printArea.scrollIntoView({ behavior: 'smooth' });
            };

            // 解答表示切り替えボタンのイベント
            toggleAnswersBtn.addEventListener('click', () => {
                answersVisible = !answersVisible;
                const problemItems = document.querySelectorAll('.problem-item');
                
                problemItems.forEach(item => {
                    const question = item.dataset.question;
                    const answer = item.dataset.answer;
                    if (answersVisible) {
                        item.innerHTML = `<span class="flex-1">${question} = <span class="font-bold text-blue-600">${answer}</span></span>`;
                    } else {
                        item.innerHTML = `<span class="flex-1">${question}</span>`;
                    }
                });
                
                toggleAnswersBtn.textContent = answersVisible ? '解答を隠す' : '解答を表示';
            });
            
            // 印刷ボタンのイベント
            printButton.addEventListener('click', () => {
                window.print();
            });

            // リセットボタン
            resetBtn.addEventListener('click', () => {
                form.reset();
                problemSettingsContainer.innerHTML = '';
                addProblemBtn.click();
                hideError();
                createBtn.disabled = false;
                createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                printArea.classList.add('hidden');
            });

        });
    </script>
</body>
</html>

